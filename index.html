<!DOCTYPE html>
<html lang="pt-BR" class="dark">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conector UAU-ZAPI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url(https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap);
      body { font-family: 'Inter', sans-serif; }
      .modal { transition: opacity 0.3s ease-in-out; }
      .modal-content { transition: transform 0.3s ease-in-out; }
    </style>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div id="webcrumbs">
      
      <!-- Modal de Exibi√ß√£o do C√≥digo de Pareamento -->
      <div id="pairing-code-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl p-6 max-w-sm mx-4 shadow-2xl transform scale-95">
          <h2 class="text-xl font-semibold mb-4 text-center">C√≥digo de Pareamento</h2>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-6 text-center">
            No seu WhatsApp, v√° em "Aparelhos Conectados" > "Conectar com n√∫mero de telefone" e digite o c√≥digo abaixo.
          </p>
          <div class="my-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg text-center">
            <span id="pairing-code" class="text-4xl font-bold tracking-widest text-blue-600 dark:text-blue-400">--- ---</span>
          </div>
          <p id="pairing-countdown" class="text-sm text-gray-500 text-center">Este c√≥digo expira em 5 minutos.</p>
          <button id="close-pairing-modal" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Fechar</button>
        </div>
      </div>

      <!-- Tutorial Modal -->
      <div id="tutorial-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-xl p-6 max-w-md mx-4 shadow-2xl transform scale-95">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
             <svg class="w-6 h-6 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
            Como Usar a Ferramenta
          </h2>
          <div class="space-y-4 text-sm text-gray-600 dark:text-gray-400">
            <div class="flex items-start"><div class="flex-shrink-0 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">1</div><p class="ml-3"><b>Verificar Status:</b> Clique para saber se a conex√£o est√° ativa (Verde) ou inativa (Vermelho).</p></div>
            <div class="flex items-start"><div class="flex-shrink-0 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">2</div><p class="ml-3"><b>Solicitar C√≥digo:</b> Se estiver desconectado, clique aqui. Um c√≥digo aparecer√° na tela.</p></div>
            <div class="flex items-start"><div class="flex-shrink-0 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">3</div><p class="ml-3">No seu celular, v√° em <b>WhatsApp > Aparelhos Conectados > Conectar com n√∫mero de telefone</b> e digite o c√≥digo.</p></div>
          </div>
          <button id="close-tutorial" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Entendi!</button>
        </div>
      </div>

      <!-- Conte√∫do Principal -->
      <div class="min-h-screen flex items-center justify-center font-sans p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-8 transition-all duration-300">
          <header class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <button id="open-tutorial" title="Mostrar tutorial" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
              <div class="flex-1 flex justify-center items-center gap-2">
                 <svg class="h-8 w-8 text-green-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.35 3.45 16.86L2.06 21.94L7.31 20.55C8.76 21.33 10.37 21.79 12.04 21.79C17.5 21.79 21.95 17.34 21.95 11.88C21.95 9.27 20.92 6.8 19.13 4.99C17.34 3.2 14.88 2.18 12.23 2.02L12.04 2M12.04 3.65C16.56 3.65 20.3 7.39 20.3 11.91C20.3 16.43 16.56 20.14 12.04 20.14C10.53 20.14 9.09 19.72 7.85 19L7.22 18.65L3.8 19.78L4.95 16.45L4.57 15.79C3.85 14.58 3.48 13.2 3.48 11.88C3.48 7.42 7.06 3.65 12.04 3.65M9.42 6.55L8.48 6.55L6.96 11.96L8.53 11.96L8.94 10.59H11.41L11.82 11.96L13.39 11.96L11.87 6.55H10.93L9.42 6.55M10.18 9.59L10.88 7.42L11.53 9.59H10.18Z"/></svg>
                 <span class="text-xl font-bold text-gray-800 dark:text-white">Conector UAU-ZAPI</span>
              </div>
                <button id="theme-toggle" title="Alternar tema" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600">
                    <svg id="theme-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            <p class="text-gray-600 dark:text-gray-300 text-sm">Ferramenta de Conex√£o UAU-ZAPI</p>
            <div class="mt-4 w-16 h-1 bg-blue-500 mx-auto rounded-full"></div>
          </header>
          
          <div class="space-y-4" id="connection-form">
            <button class="w-full bg-blue-600 text-white font-medium py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-200 transform hover:shadow-lg flex items-center justify-center gap-2" id="get-pairing-code">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
              Solicitar C√≥digo de Pareamento
            </button>
            <button class="w-full bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-medium py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors flex items-center justify-center gap-2" id="check-status">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M12 21v-1m-4.636-3.364l.707-.707m0-9.192l-.707-.707"></path></svg>
                Verificar Status da Conex√£o
            </button>
          </div>

          <div id="status-display" class="hidden mt-6"></div>
          
          <!-- Debug Info -->
          <div id="debug-info" class="mt-6 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg hidden">
            <p class="text-xs font-semibold text-blue-800 dark:text-blue-200 mb-1">üîç Debug - Configura√ß√£o Carregada:</p>
            <div class="text-xs text-blue-700 dark:text-blue-300 font-mono space-y-1" id="debug-content"></div>
          </div>
          
           <footer class="mt-8 pt-4 border-t border-gray-100 dark:border-gray-700 text-center"><p class="text-xs text-gray-500 dark:text-gray-400">Integra√ß√£o com UAU-ZAPI</p></footer>
        </div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- ELEMENTOS DO DOM ---
      const pairingCodeModal = document.getElementById('pairing-code-modal');
      const closePairingModalBtn = document.getElementById('close-pairing-modal');
      const pairingCodeEl = document.getElementById('pairing-code');
      const pairingCountdownEl = document.getElementById('pairing-countdown');
      
      const tutorialModal = document.getElementById('tutorial-modal');
      const openTutorialBtn = document.getElementById('open-tutorial');
      const closeTutorialBtn = document.getElementById('close-tutorial');
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');

      const getPairingCodeBtn = document.getElementById('get-pairing-code');
      const checkStatusBtn = document.getElementById('check-status');

      let countdownInterval;

      // --- CONTROLES DOS MODAIS E TEMA ---
      const openModal = (modal) => {
        modal.classList.remove('hidden');
        setTimeout(() => {
          modal.classList.remove('opacity-0');
          modal.querySelector('.modal-content').classList.remove('scale-95');
        }, 10);
      };

      const closeModal = (modal) => {
        clearInterval(countdownInterval);
        modal.classList.add('opacity-0');
        modal.querySelector('.modal-content').classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
      };

      openTutorialBtn.addEventListener('click', () => openModal(tutorialModal));
      closeTutorialBtn.addEventListener('click', () => {
        closeModal(tutorialModal);
        localStorage.setItem('tutorialSeen', 'true');
      });
      closePairingModalBtn.addEventListener('click', () => closeModal(pairingCodeModal));

      const setTheme = (theme) => {
        localStorage.setItem('theme', theme);
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
          themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>`;
        } else {
          document.documentElement.classList.remove('dark');
          themeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>`;
        }
      };

      themeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark');
        setTheme(isDark ? 'light' : 'dark');
      });
      
      const initTheme = () => {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme) setTheme(savedTheme);
        else setTheme(systemPrefersDark ? 'dark' : 'light');
      };

      // --- DECODIFICA√á√ÉO BASE64 SEGURA ---
      function safeBase64Decode(str) {
        try {
          // Restaura caracteres especiais do Base64 URL-safe
          let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
          // Adiciona padding se necess√°rio
          while (base64.length % 4) {
            base64 += '=';
          }
          // Decodifica Base64 para bytes UTF-8
          const binaryString = atob(base64);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const decoded = new TextDecoder().decode(bytes);
          return decoded;
        } catch (error) {
          console.error('Erro ao decodificar Base64:', error);
          return null;
        }
      }

      // --- GERENCIAMENTO DE CONFIGURA√á√ïES ---
      const loadConfigFromURL = () => {
        const params = new URLSearchParams(window.location.search);
        const configParam = params.get('config');
        
        if (configParam) {
          try {
            const decodedJson = safeBase64Decode(configParam);
            if (!decodedJson) {
              throw new Error('Falha na decodifica√ß√£o Base64');
            }
            
            const decodedConfig = JSON.parse(decodedJson);
            
            // Salva no localStorage
            for (const key in decodedConfig) {
              localStorage.setItem(key, decodedConfig[key]);
            }
            
            // Mostra debug
            showDebugInfo(decodedConfig);
            updateStatusDisplay('success', 'Configura√ß√£o carregada com sucesso!');
            
            // Limpa a URL
            history.replaceState(null, '', window.location.pathname);
          } catch (e) {
            console.error('Erro ao carregar config:', e);
            updateStatusDisplay('error', 'Falha ao carregar configura√ß√£o do link. Verifique o link gerado.');
          }
        } else {
          // Verifica se j√° tem config salva
          const savedUrl = localStorage.getItem('apiBaseUrl');
          const savedKey = localStorage.getItem('apiKey');
          const savedPhone = localStorage.getItem('phoneNumber');
          
          if (savedUrl && savedKey && savedPhone) {
            showDebugInfo({
              apiBaseUrl: savedUrl,
              apiKey: savedKey,
              phoneNumber: savedPhone
            });
          }
        }
      };

      // --- DEBUG INFO ---
      function showDebugInfo(config) {
        const debugDiv = document.getElementById('debug-info');
        const debugContent = document.getElementById('debug-content');
        
        debugContent.innerHTML = `
          <div><strong>API URL:</strong> ${config.apiBaseUrl}</div>
          <div><strong>Token:</strong> ${config.apiKey.substring(0, 8)}...${config.apiKey.substring(config.apiKey.length - 4)}</div>
          <div><strong>Telefone:</strong> ${config.phoneNumber}</div>
        `;
        
        debugDiv.classList.remove('hidden');
      }

      // --- L√ìGICA PRINCIPAL DA APLICA√á√ÉO ---
      const updateStatusDisplay = (type, message, sticky = false) => {
          const statusDisplay = document.getElementById('status-display');
          const colors = {
              success: { bg: 'bg-green-100 dark:bg-green-900', border: 'border-green-300 dark:border-green-700', text: 'text-green-800 dark:text-green-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' },
              error: { bg: 'bg-red-100 dark:bg-red-900', border: 'border-red-300 dark:border-red-700', text: 'text-red-800 dark:text-red-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' },
              info: { bg: 'bg-blue-100 dark:bg-blue-900', border: 'border-blue-300 dark:border-blue-700', text: 'text-blue-800 dark:text-blue-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' }
          };
          const c = colors[type];
          statusDisplay.innerHTML = `<div class="${c.bg} ${c.border} border rounded-lg p-4"><div class="flex items-center justify-center"><svg class="h-5 w-5 ${c.text} mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">${c.icon}</svg><p class="${c.text} text-sm font-medium">${message}</p></div></div>`;
          statusDisplay.classList.remove('hidden');

          if (!sticky) {
              setTimeout(() => {
                  if (statusDisplay.innerHTML.includes(message)) {
                      statusDisplay.classList.add('hidden');
                  }
              }, 4000);
          }
      };
      
      const validateInputs = () => {
          const apiBaseUrl = localStorage.getItem('apiBaseUrl');
          const apiKey = localStorage.getItem('apiKey');
          const phoneNumber = localStorage.getItem('phoneNumber');
          
          if (!apiBaseUrl || !apiKey || !phoneNumber) {
              updateStatusDisplay('error', 'Configura√ß√£o ausente. Use o link de configura√ß√£o fornecido pelo administrador.');
              return false;
          }
          
          console.log('‚úì Configura√ß√£o validada:', { apiBaseUrl, apiKey: apiKey.substring(0, 10) + '...', phoneNumber });
          return true;
      };

      const startPairingCountdown = () => {
          clearInterval(countdownInterval);
          let timeLeft = 300; // 5 minutos
          pairingCountdownEl.textContent = 'Este c√≥digo expira em 5:00';
          
          countdownInterval = setInterval(() => {
              timeLeft--;
              const minutes = Math.floor(timeLeft / 60);
              const seconds = timeLeft % 60;
              pairingCountdownEl.textContent = `Este c√≥digo expira em ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
              
              if (timeLeft <= 0) {
                  clearInterval(countdownInterval);
                  closeModal(pairingCodeModal);
                  updateStatusDisplay('error', 'C√≥digo de pareamento expirou. Solicite um novo.');
              }
          }, 1000);
      };
      
      const getPairingCode = async () => {
          if (!validateInputs()) return;

          const baseUrl = localStorage.getItem('apiBaseUrl');
          const apiKey = localStorage.getItem('apiKey');
          const phone = localStorage.getItem('phoneNumber');
          
          updateStatusDisplay('info', 'Solicitando c√≥digo de pareamento...');

          try {
              const payload = { phone: phone };
              
              console.log('‚Üí POST', `${baseUrl}/instance/connect`);
              console.log('‚Üí Headers:', { 'Content-Type': 'application/json', 'Accept': 'application/json', 'token': apiKey.substring(0, 10) + '...' });
              console.log('‚Üí Body:', payload);
              
              const response = await fetch(`${baseUrl}/instance/connect`, {
                  method: 'POST',
                  headers: { 
                      'Content-Type': 'application/json',
                      'Accept': 'application/json',
                      'token': apiKey  // ‚úÖ CORRIGIDO: agora usa 'token' min√∫sculo
                  },
                  body: JSON.stringify(payload)
              });

              console.log('‚Üê Response status:', response.status);

              if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ message: `A API retornou um erro ${response.status} sem detalhes.` }));
                 console.error('‚Üê Erro da API:', errorData);
                 throw new Error(errorData.message || `Erro ${response.status}`);
              }

              const data = await response.json();
              console.log('‚Üê Response data:', data);
              
              // A UAU-ZAPI pode retornar o c√≥digo em diferentes formatos
              const code = data.code || data.pairingCode || data.pairing_code;

              if (!code) {
                  console.error('Resposta completa:', data);
                  throw new Error("API n√£o retornou um c√≥digo de pareamento. Verifique a resposta no console.");
              }

              // Formata o c√≥digo para "123-456" se ele vier como "123456"
              let formattedCode = code.replace(/-/g, '');
              if (formattedCode.length === 6) {
                  formattedCode = `${formattedCode.substring(0, 3)}-${formattedCode.substring(3, 6)}`;
              } else if (formattedCode.length === 8) {
                  formattedCode = `${formattedCode.substring(0, 4)}-${formattedCode.substring(4, 8)}`;
              }
              
              pairingCodeEl.textContent = formattedCode;
              openModal(pairingCodeModal);
              startPairingCountdown();
              updateStatusDisplay('success', 'C√≥digo recebido. Use-o no seu celular.', true);

          } catch (error) {
              console.error("Erro ao solicitar c√≥digo:", error);
              updateStatusDisplay('error', `Falha na API: ${error.message}`);
          }
      };

      const checkConnectionStatus = async () => {
        if (!validateInputs()) return;

        const baseUrl = localStorage.getItem('apiBaseUrl');
        const apiKey = localStorage.getItem('apiKey');

        updateStatusDisplay('info', 'Verificando status...');

        try {
            console.log('‚Üí GET', `${baseUrl}/instance/status`);
            console.log('‚Üí Headers:', { 'Accept': 'application/json', 'token': apiKey.substring(0, 10) + '...' });
            
            const response = await fetch(`${baseUrl}/instance/status`, {
                method: 'GET',
                headers: { 
                    'Accept': 'application/json',
                    'token': apiKey  // ‚úÖ CORRIGIDO: agora usa 'token' min√∫sculo
                }
            });

            console.log('‚Üê Response status:', response.status);

            if (!response.ok) {
                const errorData = await response.json().catch(()=> ({}));
                console.error('‚Üê Erro da API:', errorData);
                throw new Error(errorData.message || `A API retornou um erro ${response.status}`);
            }

            const data = await response.json();
            console.log('‚Üê Response data:', data);
            
            // A UAU-ZAPI pode retornar em diferentes formatos
            const state = data.instance?.state || data.status || data.state;

            if (state === 'connected' || state === 'open' || state === 'CONNECTED') {
                updateStatusDisplay('success', '‚úì Status da Conex√£o: CONECTADO', true);
            } else if (state === 'disconnected' || state === 'close' || state === 'DISCONNECTED') {
                updateStatusDisplay('error', '‚úó Status da Conex√£o: DESCONECTADO', true);
            } else {
                updateStatusDisplay('info', `Status da Conex√£o: ${state}`, true);
            }
        } catch (error) {
            console.error("Erro ao verificar status:", error);
            updateStatusDisplay('error', `Falha ao verificar status: ${error.message}`);
        }
      };

      // --- EVENT LISTENERS ---
      getPairingCodeBtn.addEventListener('click', getPairingCode);
      checkStatusBtn.addEventListener('click', checkConnectionStatus);

      // --- INICIALIZA√á√ÉO ---
      initTheme();
      loadConfigFromURL();
      
      if (!localStorage.getItem('tutorialSeen') && !new URLSearchParams(window.location.search).has('config')) {
        setTimeout(() => openModal(tutorialModal), 500);
      }
    });
    </script>
  </body>
</html>
